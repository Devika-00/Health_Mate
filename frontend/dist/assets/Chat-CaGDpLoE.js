import{r as o,j as e,U as E,q as D,H as A,C as j}from"./index-BwAjAq79.js";import{a as g}from"./axiosService-BFAGqF_s.js";import{f as P}from"./index-D9k2I5J1.js";import{N as R}from"./navbar-DVSHNQbA.js";import{c as C}from"./index-DN9pZWzW.js";import"./axios-Cm0UX6qg.js";import"./index-VWaDGczM.js";import"./toaster-CIcOBpXB.js";import"./iconBase-B_6Rqdhz.js";const U=({conversation:r,lastMessage:i})=>{const[c,t]=o.useState({});return o.useEffect(()=>{(async()=>{try{const m=r.members[1],u=await g.get(`${E}/doctor/${m}`);t(u.data.doctor)}catch(m){console.error("Error fetching doctor data:",m)}})()},[r]),console.log(c,"checking"),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-2 flex flex-col mb-1",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start",children:[e.jsx("img",{className:"w-14 h-14 rounded-full object-cover mb-2 sm:mb-0 sm:mr-4",src:c.profileImage,alt:"Doctor Profile"}),e.jsxs("div",{className:"flex flex-col text-center sm:text-left",children:[e.jsx("span",{className:"font-medium",children:c.doctorName}),e.jsx("span",{className:"text-gray-500 text-sm",children:i==null?void 0:i.text})]})]})})},F=({message:r,own:i,receiverProfilePicture:c,receiverName:t})=>e.jsxs("div",{className:`message flex flex-col mt-5 ml-5 ${i?"items-end":"items-start"}`,children:[e.jsx("div",{className:"fixed top-1 left-0  w-full lg:w-3/4 lg:ml-96 mt-16 h-13 bg-gray-200 flex items-center justify-between p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("img",{src:c,alt:"Profile",className:"w-10 h-10 rounded-full mr-4"}),e.jsx("span",{className:"text-xl font-bold",children:t})]})}),e.jsx("div",{className:"flex mt-14",children:e.jsx("p",{className:`messageText p-2 rounded-lg ${i?"bg-blue-500 text-white":"bg-gray-300 text-black"}`,children:r==null?void 0:r.text})}),e.jsx("div",{className:"text-xs mt-1",children:r!=null&&r.createdAt?P(r.createdAt):""})]}),G=()=>{const r=D(s=>s.UserSlice),[i,c]=o.useState([]),[t,N]=o.useState(null),[m,u]=o.useState([]),[v,b]=o.useState(""),[x,I]=o.useState(null),[f,S]=o.useState(null),w=o.useRef(null),l=A();o.useEffect(()=>{l==null||l.on("getMessage",s=>{I({senderId:s.senderId,text:s.text,createdAt:Date.now()})})},[]),o.useEffect(()=>{x&&(t!=null&&t.members.includes(x.senderId))&&u(s=>[...s,x]),x&&c(s=>s.map(a=>a._id===(t==null?void 0:t._id)?{...a,lastMessage:x}:a))},[x,t]),o.useEffect(()=>{l==null||l.emit("addUser",r.id),l==null||l.on("getUsers",s=>{})},[r]),o.useEffect(()=>{(async()=>{try{const n=(await g.get(`${j}/conversations/${r.id}`)).data,d=await Promise.all(n.map(async h=>{const y=(await g.get(`${j}/messages/${h._id}`)).data.messages,_=y[y.length-1];return{...h,lastMessage:_}}));c(d)}catch(a){console.error("Error fetching conversations:",a)}})()},[r.id]),o.useEffect(()=>{(async()=>{if(t)try{const a=await g.get(`${j}/messages/${t._id}`);u(a.data.messages)}catch(a){console.error("Error fetching messages:",a)}})()},[t]);const $=async s=>{N(s);const a=s.members.find(n=>n!==r.id);try{const n=await g.get(`${E}/doctor/${a}`);S(n.data.doctor)}catch(n){console.error("Error fetching receiver details:",n)}},M=async s=>{s.preventDefault();const a={senderId:r.id,text:v,conversationId:t==null?void 0:t._id},n=t.members.find(d=>d!==r.id);l==null||l.emit("sendMessage",{senderId:r.id,receiverId:n,text:v,conversationId:t==null?void 0:t._id});try{const d=await g.post(`${j}/messages`,a);u([...m,d.data]),b(""),c(h=>h.map(p=>p._id===(t==null?void 0:t._id)?{...p,lastMessage:d.data}:p))}catch(d){console.error("Error sending message:",d)}};return o.useEffect(()=>{var s;(s=w.current)==null||s.scrollIntoView({behavior:"smooth"})},[m]),e.jsxs(e.Fragment,{children:[e.jsx(R,{}),e.jsxs("div",{className:"h-[664px] flex flex-col lg:flex-row",children:[e.jsx("div",{className:"w-full lg:w-1/4 bg-gray-200",children:e.jsx("div",{className:"p-4 h-full flex flex-col",children:i.map((s,a)=>e.jsx("div",{onClick:()=>$(s),children:e.jsx(U,{conversation:s,lastMessage:s.lastMessage})},a))})}),e.jsx("div",{className:"w-full lg:w-3/4 bg-gray-100",children:e.jsx("div",{className:"flex flex-col h-full",children:e.jsx("div",{className:"h-full flex flex-col overflow-y-scroll pr-4",children:t?e.jsxs(e.Fragment,{children:[m.map((s,a)=>e.jsx("div",{className:"flex-1",ref:w,children:e.jsx(F,{message:s,own:s.senderId===r.id,receiverProfilePicture:f==null?void 0:f.profileImage,receiverName:f==null?void 0:f.doctorName})},a)),e.jsxs("div",{className:"flex items-center",children:[e.jsx("textarea",{className:"w-full px-3 py-1 border border-gray-300 rounded-lg focus:outline-none ml-4 mb-5",placeholder:"Write a message...",onChange:s=>b(s.target.value),value:v}),e.jsx("button",{className:"ml-2 mb-5 mr-5 px-5 py-3 bg-blue-500 text-white rounded-md cursor-pointer focus:outline-none hover:bg-blue-600",onClick:M,children:e.jsx(C,{size:18})})]})]}):e.jsx("div",{className:"text-center text-5xl text-gray-400 cursor-default mt-20 lg:mt-52",children:"Open a chat to start conversation.."})})})})]})]})};export{G as default};
