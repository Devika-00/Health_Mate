import{r as c,j as e,D,q as T,H as _,C as v}from"./index-oItXcVYM.js";import{a as u}from"./axiosService-DvvlfsEg.js";import{f as S}from"./index-D9k2I5J1.js";import{N as C}from"./navbar-Bj9hSa6q.js";import{c as P}from"./index-CXbB5xeG.js";import"./axios-Cm0UX6qg.js";import"./index-VWaDGczM.js";import"./toaster-DarDu_0W.js";import"./iconBase-Vv0ujInU.js";const R=({conversation:a,lastMessage:g})=>{const[m,t]=c.useState({});return c.useEffect(()=>{(async()=>{try{const f=a.members[0],h=await u.get(`${D}/user/${f}`);t(h.data.user)}catch(f){console.error("Error fetching doctor data:",f)}})()},[a,g]),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-2 flex flex-col mb-1",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start",children:[e.jsx("img",{className:"w-14 h-14 rounded-full object-cover mb-2 sm:mb-0 sm:mr-4",src:m.profilePicture,alt:"Doctor Profile"}),e.jsxs("div",{className:"flex flex-col text-center sm:text-left",children:[e.jsx("span",{className:"font-medium",children:m.name}),e.jsx("span",{className:"text-gray-500 text-sm",children:g==null?void 0:g.text})]})]})})},F=({message:a,own:g,receiverProfilePicture:m,receiverName:t})=>e.jsxs("div",{className:`message flex flex-col mt-5 ml-5 ${g?"items-end":"items-start"}`,children:[e.jsx("div",{className:"fixed top-1 left-0  w-full lg:w-3/4 lg:ml-96 mt-16 h-13 bg-gray-200 flex items-center justify-between p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("img",{src:m,alt:"Profile",className:"w-10 h-10 rounded-full mr-4"}),e.jsx("span",{className:"text-xl font-bold",children:t})]})}),e.jsx("div",{className:"flex mt-14",children:e.jsx("p",{className:`messageText p-2 rounded-lg ${g?"bg-blue-500 text-white":"bg-gray-300 text-black"}`,children:a==null?void 0:a.text})}),e.jsx("div",{className:"text-xs mt-1",children:a!=null&&a.createdAt?S(a.createdAt):""})]}),B=()=>{const a=T(s=>s.DoctorSlice),[g,m]=c.useState([]),[t,N]=c.useState(null),[f,h]=c.useState([]),[b,M]=c.useState(""),[w,A]=c.useState(null),[p,$]=c.useState(null),o=_(),y=c.useRef(null);c.useEffect(()=>{o==null||o.on("getMessage",s=>{A({senderId:s.senderId,text:s.text,createdAt:Date.now()})}),o==null||o.on("updateLastMessage",s=>{m(r=>{const d=r.map(l=>l._id===s.conversationId?{...l,lastMessage:s.lastMessage}:l);return d.sort((l,n)=>new Date(n.lastMessage.createdAt).getTime()-new Date(l.lastMessage.createdAt).getTime()),d})})},[]),c.useEffect(()=>{w&&(t!=null&&t.members.includes(w.senderId)&&h(s=>[...s,w]),m(s=>{const r=s.map(d=>d._id===(t==null?void 0:t._id)?{...d,lastMessage:w}:d);return r.sort((d,l)=>new Date(l.lastMessage.createdAt).getTime()-new Date(d.lastMessage.createdAt).getTime()),r}))},[w,t]),c.useEffect(()=>{o==null||o.emit("addUser",a.id),o==null||o.on("getUsers",()=>{})},[a]),c.useEffect(()=>{(async()=>{try{const d=(await u.get(`${v}/conversations/${a.id}`)).data,l=await Promise.all(d.map(async n=>{const i=(await u.get(`${v}/messages/${n._id}`)).data.messages,j=i[i.length-1];return{...n,lastMessage:j}}));l.sort((n,x)=>new Date(x.lastMessage.createdAt).getTime()-new Date(n.lastMessage.createdAt).getTime()),m(l)}catch(r){console.error("Error fetching conversations:",r)}})()},[a.id]),c.useEffect(()=>{(async()=>{if(t)try{const r=await u.get(`${v}/messages/${t._id}`);h(r.data.messages)}catch(r){console.error("Error fetching messages:",r)}})()},[t]);const E=async s=>{N(s);const r=s.members.find(n=>n!==a.id);try{const n=await u.get(`${D}/user/${r}`);$(n.data.user)}catch(n){console.error("Error fetching receiver details:",n)}const l=(await u.get(`${v}/messages/${s._id}`)).data.messages.slice(-1)[0];m(n=>{const x=n.map(i=>i._id===s._id?{...i,lastMessage:l}:i);return x.sort((i,j)=>new Date(j.lastMessage.createdAt).getTime()-new Date(i.lastMessage.createdAt).getTime()),x})},I=async s=>{s.preventDefault();const r={senderId:a.id,text:b,conversationId:t==null?void 0:t._id},d=t.members.find(l=>l!==a.id);o==null||o.emit("sendMessage",{senderId:a.id,receiverId:d,text:b,conversationId:t==null?void 0:t._id});try{const l=await u.post(`${v}/messages`,r);h([...f,l.data]),M(""),m(n=>{const x=n.map(i=>i._id===(t==null?void 0:t._id)?{...i,lastMessage:l.data}:i);return x.sort((i,j)=>new Date(j.lastMessage.createdAt).getTime()-new Date(i.lastMessage.createdAt).getTime()),x})}catch(l){console.error("Error sending message:",l)}};return c.useEffect(()=>{var s;(s=y.current)==null||s.scrollIntoView({behavior:"smooth"})},[f]),e.jsxs(e.Fragment,{children:[e.jsx(C,{}),e.jsxs("div",{className:"h-screen flex flex-col lg:flex-row",children:[e.jsx("div",{className:"w-full lg:w-1/4 bg-gray-200",children:e.jsx("div",{className:"p-4 h-full flex flex-col",children:g.map((s,r)=>e.jsx("div",{onClick:()=>E(s),className:"cursor-pointer hover:bg-gray-300 p-2 rounded-lg",children:e.jsx(R,{conversation:s,lastMessage:s.lastMessage})},r))})}),e.jsx("div",{className:"w-full lg:w-3/4 bg-gray-100 flex flex-col",children:e.jsx("div",{className:"flex-1 flex flex-col overflow-y-scroll p-4",children:t?e.jsxs(e.Fragment,{children:[f.map((s,r)=>e.jsx("div",{ref:y,children:e.jsx(F,{message:s,own:s.senderId===a.id,receiverProfilePicture:p==null?void 0:p.profilePicture,receiverName:p==null?void 0:p.name})},r)),e.jsxs("div",{className:"flex items-center mt-auto",children:[e.jsx("textarea",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none",placeholder:"Write a message...",onChange:s=>M(s.target.value),value:b}),e.jsx("button",{className:"ml-2 px-3 py-2 bg-blue-500 text-white rounded-lg cursor-pointer focus:outline-none hover:bg-blue-600",onClick:I,children:e.jsx(P,{size:18})})]})]}):e.jsx("div",{className:"text-center text-xl text-gray-400 mt-20 lg:mt-52",children:"Open a chat to start conversation.."})})})]})]})};export{B as default};
